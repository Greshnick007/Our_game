<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>CounterStrike</title>
	</head>
<body>
<canvas id="canvas">

</canvas>
<script>
var bullets = [];
var points = [];


var oldX = 0;
var oldY = 0;
var pic  = new Image();
pic.src  = 'bum.png';
var avatar = new Image();
avatar.src = 'avatar.png';
var canvas = document.getElementById("canvas");
context = canvas.getContext("2d");
var k = 105;

var x_pos = 0;
var down = false;
var PastTime = 0;



/*
 * Класс оружия
*/
class Weapon {
    constructor(imageSource, soundSource, speedShoot) {
        this.setImage(imageSource); // Изображение оружия
        this.setSound(soundSource); // Звук оружия
        this.isActive = false; // Является выбранным?
        this.setSpeedShoot(speedShoot); // Скорострельность
    }

    setSpeedShoot(arg) {
        this.speedShot = arg;
    }

    getSpeedShoot(arg) {
        return this.speedShot;
    }

    setSound(arg) {
        this.srcAudio = arg;
    }

    playSound() {
        this.audio = new Audio();
        this.audio.src = this.srcAudio;
        this.audio.play();
    }

    setImage(arg) {
        this.image = new Image();
        this.image.src = arg;
    }

    getImage() {
        return this.image;
    }

    setIsActive(arg) {
        this.isActive = arg;
    }

    getIsActive() {
        return this.isActive;
    }
}

class Pistol extends Weapon {
    constructor() {
        super('Pistols.png', 'Pistol.mp3', 2);
    }
}

class Rifle extends Weapon {
    constructor() {
        super('Ralfe.png', 'Ralfe.mp3', 5);
    }
}

class Shotgun extends Weapon {
    constructor() {
        super('Drobash.png', 'Drobovick.mp3', 1);
    }
}

/*
 * Класс для хранения данных о статистике
 */
class Statistic {

    constructor() {
        this.hits = 0; // Попадания
        this.missed = 0; // Мимо
        this.score = 0; // Текущие очки
    }

    addScore(arg) {
        this.score += arg;
    }

    addMissed(arg) {
        this.missed += arg;
    }

    addHits(arg) {
        this.hits += arg;
    }

    getScore(){
        return this.score;
    }

    getHits(){
        return this.hits;
    }

    getMissed(){
        return this.missed;
    }

    clearStat() {
        constructor();
    }
}


let stat = new Statistic();

let weapons = [];
weapons.push(new Pistol());
weapons.push(new Rifle());
weapons.push(new Shotgun());
weapons[0].setIsActive(true);


function init() {
	//alert('Смена оружия на клавиши: 1 и 2. На основной клавиатуре')
	canvas.width = document.documentElement.clientWidth;
	canvas.height = document.documentElement.clientHeight;
	canvas.onmousemove = mouse_position;
	canvas.onmousedown = mouse_down;
	canvas.onmouseup = mouse_up;
	//canvas.onclick = mouse_click;
	document.onkeydown = changeWeapons;
	setInterval(play, 1000 / 50);
}

function play () {
    draw ();
    drawCursor(oldX, oldY);
    if (down == true) {
        shooting(oldX, oldY);
    }
}

function draw() {
context.beginPath();
context.fillStyle = "#687F75";
context.fillRect(0, 0, canvas.width, canvas.height);
context.closePath();

	if (x_pos >= canvas.width) {x_pos =0; bullets = [];}
	x_pos+=5;
    for (var i=0; i<=bullets.length-1; i++) {
        drawBum(bullets[i][0], bullets[i][1]);
    }
	michen(x_pos, (canvas.height/2)-50+Math.sin(x_pos/100)*100);
	for (var i=0; i<=points.length-1; i++) {
		points[i][0] +=5;
		drawBum(points[i][0], points[i][1]+Math.sin(x_pos/100)*100);
	}
user_interface();
}

function user_interface() {

    weapons.forEach(function(weapon, i, arr) {
        context.beginPath();
        context.strokeStyle = "#1B1FFF";
        if (weapon.getIsActive() === true) {context.fillStyle = "#ccc";}
        else {context.fillStyle = "#fff";}
        context.strokeRect(5+(165*i),5, 155, 85);
        context.fillRect(5+(165*i),5, 155, 85);
        context.drawImage(weapon.getImage(), 10+(165*i), 10);
        context.closePath();
    }); // Рендерим оружие

	context.beginPath();
	context.strokeStyle = "#1B1FFF";
	context.fillStyle = "#1B1FFF";
	context.arc(85, canvas.height-85, 80, 0, 2 * Math.PI);
	context.fillRect(5,canvas.height-85, canvas.width-15, 80);
	context.fill();
	context.drawImage(avatar, 10, canvas.height-160);
	context.strokeStyle = "#FFF";
	context.font = 'bold 30px sans-serif';
	context.strokeText(stat.getScore(), canvas.width/2, canvas.height-35);
	context.strokeText('Попал: '+stat.getHits(), 400, canvas.height-35);
	context.strokeText('Мимо: '+stat.getMissed(), 900, canvas.height-35);
	context.closePath();

}

function michen (x, y) {
	var k = 200;
	for (var i= 0; i<=9; i++) {
		context.beginPath();
		context.strokeStyle ="#1B1FFF";
		context.fillStyle ="#FFF";
		context.arc(x, y, k, 0, 2*Math.PI);
		context.fill();
		context.stroke();
		context.closePath();
		k = k - 20;
	}
	context.beginPath();
	context.fillStyle ="#1B1FFF";
	context.arc(x, y, 20, 0, 2*Math.PI);
	context.fill();
	context.closePath();
}

function drawCursor(x, y) {
	context.beginPath();
	context.strokeStyle = "#000";
	context.arc(x, y, 16, 0, 2 * Math.PI);
	context.moveTo(x, y-16);
	context.lineTo(x, y+16);
	context.moveTo(x-16, y);
	context.lineTo(x+16, y);
	context.stroke();
	context.closePath();
}

function mouse_position(event) {
    var x = 0;
	var y = 0;
    if (document.attachEvent != null) {
        x = window.event.clientX;
        y = window.event.clientY;
    } else if (!document.attachEvent && document.addEventListener) {
        x = event.clientX;
        y = event.clientY;
    }

	drawCursor(x, y);
	oldX = x;
	oldY = y;
}

function drawBum(x, y) {
	context.beginPath();
    context.drawImage(pic, x-15, y-15);  // Рисуем изображение от точки с координатами 0, 0
	context.closePath();
}


function mouse_down (event) {
	down = true;
}

function mouse_up (event) {
	down = false;
}

function changeWeapons(event) {
    weapons.forEach(function(weapon, i, list) {
        weapon.setIsActive(false)
    });
    weapons[event.keyCode - 49].setIsActive(true);
}

function shooting(x, y) {
    var d = new Date();
    weapons.forEach(function (weapon, i, arr) {
        if(weapon.getIsActive()) {
            if (d.getTime()-PastTime >= 1000/weapon.getSpeedShoot()) {
                shoot(x,y);
                PastTime = d.getTime();
            }
        }
    });
}

function auto_shoot(x,y) {
	var d = new Date();
	if (weapons[1].getIsActive() == true) {
		if (d.getTime()-PastTime >= 100) {
			shoot(x,y);
			PastTime = d.getTime();
		}
	}
}

function shoot(x,y) {
    weapons.forEach(function (weapon, i, arr) {
       if(weapon.getIsActive()) weapon.playSound();
    });
	drawBum(x, y);
	xc = x_pos;
	yc = (canvas.height/2)-50;
	var d=Math.sqrt(Math.pow(y-yc,2)+Math.pow(x-xc, 2));
	var rez = Math.ceil(d/20);

	if (rez<=10) {

		stat.addScore( Math.ceil(100/rez) );
        stat.addHits(1);

		if (points.length-1>=29) {
			points.shift();
		}
		points.push([x, y-Math.sin(x_pos/100)*100]);
	} else {
	    stat.addMissed(1);

		if (bullets.length-1>=30) {
			bullets.shift();
		}

		bullets.push([x, y]);
	}
}


function mouse_click (event) {
	x = 0; y = 0;
    if (document.attachEvent != null) {
        x = window.event.clientX;
        y = window.event.clientY;
    } else if (!document.attachEvent && document.addEventListener) {
        x = event.clientX;
        y = event.clientY;
    }

    /*
    НУЖНО РЕФАКТОРИТЬ
     */
	if (weapons[0].getIsActive() == true) {
	    shoot(x,y);
	}
	if (weapons[2].getIsActive() == true) {
        for ($i=0; $i<=9; $i++) {
            drob_x=getRandomInt(x-60, x+60);
            drob_y=getRandomInt(y-60, y+60);
            shoot(drob_x, drob_y);
        }
	}
}

function getRandomInt(min, max)
{
	return Math.floor(Math.random() * (max - min + 1)) + min;
}


init();
</script>
<style>
body, html {
padding : 0;
margin : 0;
}
#canvas {
cursor : none;
}
</style>
</body>
</html>